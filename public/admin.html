<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Admin - Locadora</title>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <div class="nav">
        <button onclick="window.location.href='index.html'">Usuário</button>
        <button onclick="window.location.href='admin.html'">Admin</button>
    </div>

    <div class="container">
        <h1>Painel Administrativo</h1>

     
        <div class="card">
            <h2>Cadastro de Veículos</h2>
            <form id="formVeiculo" class="form-veiculo">
                <label>Marca:
                    <input type="text" name="marca" placeholder="Ex: Toyota" required>
                </label>
                <label>Modelo:
                    <input type="text" name="modelo" placeholder="Ex: Corolla" required>
                </label>
                <label>Ano:
                    <input type="number" name="ano" placeholder="Ex: 2023" min="1900" max="2030" required>
                </label>
                <label>Placa:
                    <input type="text" name="placa" placeholder="Ex: ABC1234" required>
                </label>
                <label>Preço/diária (R$):
                    <input type="number" name="precoDiaria" placeholder="Ex: 150.00" step="0.01" min="0" required>
                </label>
                <label>Disponível:
                    <select name="disponivel" required>
                        <option value="true">Sim</option>
                        <option value="false">Não</option>
                    </select>
                </label>
                <label>Foto do veículo:
                    <input type="file" name="imagem" accept="image/*">
                </label>
                <button type="submit">Cadastrar Veículo</button>
            </form>
            <div id="mensagemVeiculo"></div>
        </div>

        <!-- Cadastro de Clientes -->
        <div class="card">
            <h2>Cadastro de Clientes</h2>
            <form id="formCliente" class="form-cliente">
                <label>Nome completo:
                    <input type="text" name="nome" placeholder="Ex: João Silva" required>
                </label>
                <label>Email:
                    <input type="email" name="email" placeholder="Ex: joao@email.com" required>
                </label>
                <label>Telefone:
                    <input type="tel" name="telefone" placeholder="Ex: (11) 99999-9999" required>
                </label>
                <button type="submit">Cadastrar Cliente</button>
            </form>
            <div id="mensagemCliente"></div>
        </div>

        <!-- Lista de Clientes Cadastrados -->
        <div class="card">
            <h2>Clientes Cadastrados</h2>
            <div id="loadingClientes" class="loading">Carregando clientes...</div>
            <table id="tabelaClientes" style="display: none;">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Telefone</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Veículos Cadastrados -->
        <div class="card">
            <h2>Veículos Cadastrados</h2>
            <button onclick="carregarVeiculos()" style="margin-bottom: 1rem;">Atualizar Lista</button>
            <div id="loadingVeiculos" class="loading">Carregando veículos...</div>
            <div id="listaVeiculos"></div>
        </div>

        <!-- Veículos Alugados -->
        <div class="card">
            <h2>Veículos Alugados</h2>
            <button onclick="carregarAlugados()" style="margin-bottom: 1rem;">Atualizar Lista</button>
            <div id="loadingAlugados" class="loading">Carregando locações...</div>
            <div id="veiculosAlugados"></div>
        </div>
    </div>

    <script>
        // Cadastro de Veículo
        document.getElementById('formVeiculo').addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const mensagem = document.getElementById('mensagemVeiculo');

            try {
                const res = await fetch('/veiculos', {
                    method: 'POST',
                    body: formData
                });

                const resultado = await res.json();

                if (resultado.sucesso) {
                    mensagem.innerHTML = '<div class="success">Veículo cadastrado com sucesso!</div>';
                    e.target.reset();
                    carregarVeiculos();
                } else {
                    mensagem.innerHTML = '<div class="error">Erro ao cadastrar veículo: ' + (resultado.error || 'Erro desconhecido') + '</div>';
                }
            } catch (err) {
                console.error('Erro:', err);
                mensagem.innerHTML = '<div class="error">Erro ao cadastrar veículo: ' + err.message + '</div>';
            }

            setTimeout(() => {
                mensagem.innerHTML = '';
            }, 5000);
        });

        // Cadastro de Cliente
        document.getElementById('formCliente').addEventListener('submit', async e => {
            e.preventDefault();
            const form = e.target;
            const dados = {
                nome: form.nome.value,
                email: form.email.value,
                telefone: form.telefone.value
            };
            const mensagem = document.getElementById('mensagemCliente');

            try {
                const res = await fetch('/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                const resultado = await res.json();

                if (resultado.sucesso) {
                    mensagem.innerHTML = '<div class="success">Cliente cadastrado com sucesso!</div>';
                    form.reset();
                    carregarClientesAdmin();
                } else {
                    mensagem.innerHTML = '<div class="error">Erro ao cadastrar cliente: ' + (resultado.error || 'Erro desconhecido') + '</div>';
                }
            } catch (err) {
                console.error('Erro:', err);
                mensagem.innerHTML = '<div class="error">Erro ao cadastrar cliente: ' + err.message + '</div>';
            }

            setTimeout(() => {
                mensagem.innerHTML = '';
            }, 5000);
        });

        // Carregar e gerenciar clientes
        async function carregarClientesAdmin() {
            const loading = document.getElementById('loadingClientes');
            const tabela = document.getElementById('tabelaClientes');
            const tbody = tabela.querySelector('tbody');

            try {
                const res = await fetch('/clientes');
                if (!res.ok) throw new Error('Erro ao carregar clientes');
                const clientes = await res.json();

                tbody.innerHTML = '';
                clientes.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" value="${c.nome || ''}" data-id="${c.rowKey}" class="nomeInput" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></td>
                        <td><input type="email" value="${c.email || ''}" data-id="${c.rowKey}" class="emailInput" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></td>
                        <td><input type="tel" value="${c.telefone || ''}" data-id="${c.rowKey}" class="telInput" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></td>
                        <td>
                            <button onclick="salvarCliente('${c.rowKey}')" style="margin: 0.25rem;">Salvar</button>
                             </td>
                    `;
                    tbody.appendChild(tr);
                });

                loading.style.display = 'none';
                tabela.style.display = 'table';
            } catch (err) {
                console.error('Erro:', err);
                loading.innerHTML = '<div class="error">Erro ao carregar clientes: ' + err.message + '</div>';
            }
        }

        async function salvarCliente(id) {
            const nome = document.querySelector(`.nomeInput[data-id='${id}']`).value;
            const email = document.querySelector(`.emailInput[data-id='${id}']`).value;
            const telefone = document.querySelector(`.telInput[data-id='${id}']`).value;

            try {
                const res = await fetch('/clientes/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, email, telefone })
                });

                const resultado = await res.json();

                if (resultado.sucesso) {
                    alert('Cliente atualizado com sucesso!');
                    carregarClientesAdmin();
                } else {
                    alert('Erro ao atualizar cliente');
                }
            } catch (err) {
                console.error('Erro:', err);
                alert('Erro ao atualizar cliente: ' + err.message);
            }
        }

        async function excluirCliente(id) {
            if (!confirm('Tem certeza que deseja excluir este cliente?\n\nEsta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const res = await fetch('/clientes/' + id, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const resultado = await res.json();

                if (resultado.sucesso) {
                    alert(resultado.mensagem || 'Cliente excluído com sucesso!');
                    carregarClientesAdmin();
                } else {
                    alert('Erro ao excluir cliente: ' + (resultado.mensagem || 'Erro desconhecido'));
                }
            } catch (err) {
                console.error('Erro:', err);

                if (err.message.includes('Failed to fetch')) {
                    alert('Erro de conexão. Verifique se o servidor está rodando.');
                } else {
                    alert('Erro ao excluir cliente: ' + err.message);
                }
            }
        }

        // Carregar veículos cadastrados
        async function carregarVeiculos() {
            const loading = document.getElementById('loadingVeiculos');
            const lista = document.getElementById('listaVeiculos');

            loading.innerHTML = 'Carregando veículos...';
            loading.style.display = 'block';
            lista.innerHTML = '';

            try {
                const res = await fetch('/veiculos/disponiveis');
                if (!res.ok) throw new Error('Erro ao carregar veículos');
                const veiculos = await res.json();

                if (veiculos.length === 0) {
                    lista.innerHTML = '<div class="error">Nenhum veículo cadastrado.</div>';
                    return;
                }

                veiculos.forEach(v => {
                    const div = document.createElement('div');
                    div.className = 'alugado';
                    div.innerHTML = `
                        <div class="veiculo-item">
                            ${v.urlImagem ?
                            `<img src="${v.urlImagem}" alt="${v.marca} ${v.modelo}" width="150">` :
                            '<div style="width: 150px; height: 100px; background: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">Sem imagem</div>'
                        }
                            <div class="veiculo-info">
                                <h3>${v.marca} ${v.modelo} (${v.ano})</h3>
                                <p><strong>Placa:</strong> ${v.placa}</p>
                                <p><strong>Preço/diária:</strong> R$ ${v.precoDiaria}</p>
                                <p><strong>Status:</strong> <span class="${v.disponivel ? 'status-ativa' : 'status-cancelada'}">${v.disponivel ? 'Disponível' : 'Indisponível'}</span></p>
                            </div>
                        </div>
                    `;
                    lista.appendChild(div);
                });

            } catch (err) {
                console.error('Erro:', err);
                lista.innerHTML = '<div class="error">Erro ao carregar veículos: ' + err.message + '</div>';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Carregar veículos alugados
        async function carregarAlugados() {
            const loading = document.getElementById('loadingAlugados');
            const container = document.getElementById('veiculosAlugados');

            loading.innerHTML = 'Carregando locações ativas...';
            loading.style.display = 'block';
            container.innerHTML = '';

            try {
                const res = await fetch('/veiculos/alugados');
                if (!res.ok) throw new Error('Erro ao carregar locações');
                const locacoes = await res.json();

                if (locacoes.length === 0) {
                    container.innerHTML = '<div class="success">Nenhum veículo alugado no momento.</div>';
                    return;
                }

                locacoes.forEach(l => {
                    const div = document.createElement('div');
                    div.className = 'alugado';
                    div.innerHTML = `
                        <div class="veiculo-item">
                            ${l.veiculo?.urlImagem ?
                            `<img src="${l.veiculo.urlImagem}" alt="${l.veiculo.marca} ${l.veiculo.modelo}" width="150">` :
                            '<div style="width: 150px; height: 100px; background: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">Sem imagem</div>'
                        }
                            <div class="veiculo-info">
                                <h3>${l.veiculo?.marca || '---'} ${l.veiculo?.modelo || '---'} (${l.veiculo?.ano || '---'})</h3>
                                <p><strong>Placa:</strong> ${l.veiculo?.placa || '---'}</p>
                                <p><strong>Cliente:</strong> ${l.cliente?.nome || '---'} (${l.cliente?.email || '---'})</p>
                                <p><strong>Período:</strong> ${l.dataInicio || '---'} até ${l.dataFim || '---'}</p>
                                <p><strong>Valor Total:</strong> R$ ${l.valorTotal || '0.00'}</p>
                                <p><strong>Status:</strong> <span class="status-ativa">${l.status || '---'}</span></p>
                            </div>
                            <div class="veiculo-actions">
                                <button onclick="cancelarLocacao('${l.id}')" style="background: #dc3545;">Cancelar Locação</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });

            } catch (err) {
                console.error('Erro:', err);
                container.innerHTML = '<div class="error">Erro ao carregar locações: ' + err.message + '</div>';
            } finally {
                loading.style.display = 'none';
            }
        }

        async function cancelarLocacao(locacaoId) {
            if (!confirm('Tem certeza que deseja cancelar esta locação?')) return;

            try {
                const res = await fetch('/cancelar-locacao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locacaoId })
                });

                const resultado = await res.json();

                if (resultado.sucesso) {
                    alert('Locação cancelada com sucesso!');
                    carregarAlugados();
                    carregarVeiculos();
                } else {
                    alert('Erro ao cancelar locação: ' + (resultado.error || 'Erro desconhecido'));
                }
            } catch (err) {
                console.error('Erro:', err);
                alert('Erro ao cancelar locação: ' + err.message);
            }
        }

        // Inicializar
        carregarClientesAdmin();
        carregarVeiculos();
        carregarAlugados();
    </script>
</body>

</html>